name: Flaky Tests Monitor

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

# Required for creating/updating issues
permissions:
  contents: read
  issues: write

jobs:
  flaky-tests:
    name: Run Flaky Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Allow failures - this is for tracking, not blocking
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Run flaky tests (with retry)
        id: flaky-tests
        run: |
          # Run flaky tests with 3 attempts - track all results
          PASS_COUNT=0
          FAIL_COUNT=0

          for attempt in 1 2 3; do
            echo "=== Attempt $attempt ===" >> flaky-test-output.txt
            if flutter test --tags flaky --reporter expanded 2>&1 | tee -a flaky-test-output.txt; then
              PASS_COUNT=$((PASS_COUNT + 1))
            else
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
          done

          echo "passes=$PASS_COUNT" >> $GITHUB_OUTPUT
          echo "failures=$FAIL_COUNT" >> $GITHUB_OUTPUT

          # Flaky = sometimes passes, sometimes fails
          if [ $PASS_COUNT -gt 0 ] && [ $FAIL_COUNT -gt 0 ]; then
            echo "flaky=true" >> $GITHUB_OUTPUT
          else
            echo "flaky=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload flaky test results
        uses: actions/upload-artifact@v4
        with:
          name: flaky-test-results-${{ github.run_number }}
          path: flaky-test-output.txt
          retention-days: 30

      - name: Create/Update Flaky Tests Issue
        if: steps.flaky-tests.outputs.failures != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('flaky-test-output.txt', 'utf8');
            const passes = '${{ steps.flaky-tests.outputs.passes }}';
            const failures = '${{ steps.flaky-tests.outputs.failures }}';
            const isFlaky = '${{ steps.flaky-tests.outputs.flaky }}' === 'true';

            // Find existing flaky tests issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'flaky-test',
              state: 'open'
            });

            const date = new Date().toISOString().split('T')[0];
            const status = isFlaky ? 'ğŸŸ¡ FLAKY' : 'ğŸ”´ FAILING';

            const body = `## Flaky Tests Report - ${date}

**Status:** ${status}
**Passes:** ${passes}/3 attempts
**Failures:** ${failures}/3 attempts

${isFlaky ? 'âš ï¸ Tests are intermittently failing - classic flakiness detected.' : 'âŒ Tests failed all attempts - may be broken, not just flaky.'}

<details>
<summary>Test Output (last 5000 chars)</summary>

\`\`\`
${output.slice(-5000)}
\`\`\`

</details>

### Quarantined Tests
- \`test/integration/auth_flow_test.dart\`
- \`test/integration/barber_search_test.dart\`
- \`test/integration/booking_flow_test.dart\`
- \`test/integration/payment_flow_test.dart\`

### Action Required
- [ ] Review failing tests
- [ ] Fix timing issues (replace \`pumpAndSettle\` with bounded pumps)
- [ ] Disable animations in affected tests
- [ ] Remove \`@Tags(['flaky'])\` once tests are stable

### KPI Target
**Flaky test count must trend DOWN weekly.**

| Week | Count | Trend |
|------|-------|-------|
| Current | 4 | - |

---
*Auto-updated by Flaky Tests Monitor. Owner: @Parlay-Kei*`;

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
              console.log(`Updated issue #${issues.data[0].number}`);
            } else {
              // Create new issue with proper labels
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ”´ Flaky Tests Require Attention',
                body: body,
                labels: ['flaky-test', 'tech-debt', 'testing'],
                assignees: ['Parlay-Kei']
              });
              console.log('Created new flaky tests tracking issue');
            }

      - name: Track flaky test metrics
        run: |
          echo "## Flaky Test Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passes | ${{ steps.flaky-tests.outputs.passes }}/3 |" >> $GITHUB_STEP_SUMMARY
          echo "| Failures | ${{ steps.flaky-tests.outputs.failures }}/3 |" >> $GITHUB_STEP_SUMMARY
          echo "| Flaky | ${{ steps.flaky-tests.outputs.flaky }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quarantined Tests | 4 |" >> $GITHUB_STEP_SUMMARY
