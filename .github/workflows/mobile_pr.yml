#===============================================================================
# Direct Cuts - Mobile PR Pipeline
#===============================================================================
# Fast feedback pipeline for pull requests targeting main/develop branches.
# Focuses on catching issues early with quick validation checks.
#
# Target: < 10 minutes total execution time
#
# Jobs:
#   1. lint      - Flutter analyze and dart format check
#   2. test      - Unit tests with coverage
#   3. build     - Debug build verification (Android only for speed)
#
# This pipeline blocks merge on failures to maintain code quality.
#===============================================================================

name: Mobile PR Checks

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      # Only run on mobile-related changes
      - 'lib/**'
      - 'test/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - 'android/**'
      - 'ios/**'
      - '.github/workflows/mobile_pr.yml'

# Cancel in-progress runs when a new commit is pushed to the same PR
concurrency:
  group: mobile-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.27.0'
  JAVA_VERSION: '17'

jobs:
  #=============================================================================
  # Job 1: Lint & Format Check
  #=============================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Check formatting
        id: format-check
        run: |
          echo "## Format Check" >> $GITHUB_STEP_SUMMARY
          if dart format --set-exit-if-changed --output=none .; then
            echo "All files are properly formatted." >> $GITHUB_STEP_SUMMARY
          else
            echo "::error::Code formatting issues found. Run 'dart format .' to fix."
            echo "Some files need formatting. Run \`dart format .\` to fix." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Analyze code
        id: analyze
        run: |
          echo "## Static Analysis" >> $GITHUB_STEP_SUMMARY
          if flutter analyze --no-fatal-infos 2>&1 | tee analysis.txt; then
            echo "No issues found." >> $GITHUB_STEP_SUMMARY
          else
            echo "::error::Code analysis found issues. See details above."
            echo "Issues found - see workflow log for details." >> $GITHUB_STEP_SUMMARY
            cat analysis.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Check for pubspec issues
        run: |
          echo "## Dependency Check" >> $GITHUB_STEP_SUMMARY
          flutter pub deps --style=compact > deps.txt 2>&1 || true
          if grep -q "Warning" deps.txt; then
            echo "Dependency warnings found:" >> $GITHUB_STEP_SUMMARY
            grep "Warning" deps.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "No dependency issues found." >> $GITHUB_STEP_SUMMARY
          fi

  #=============================================================================
  # Job 2: Unit Tests
  #=============================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Run unit tests
        id: tests
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          if flutter test --coverage --reporter expanded 2>&1 | tee test_output.txt; then
            echo "All tests passed." >> $GITHUB_STEP_SUMMARY

            # Extract test count if available
            TESTS=$(grep -oP '\d+(?= tests?)' test_output.txt | tail -1 || echo "unknown")
            echo "Total tests run: $TESTS" >> $GITHUB_STEP_SUMMARY
          else
            echo "::error::Some tests failed. See details above."
            echo "Some tests failed - see workflow log for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload coverage report
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage/lcov.info
          retention-days: 7

      - name: Coverage summary
        if: success()
        run: |
          if [ -f coverage/lcov.info ]; then
            # Calculate coverage percentage
            LINES=$(grep -oP 'LF:\d+' coverage/lcov.info | cut -d: -f2 | paste -sd+ | bc || echo "0")
            HITS=$(grep -oP 'LH:\d+' coverage/lcov.info | cut -d: -f2 | paste -sd+ | bc || echo "0")
            if [ "$LINES" -gt 0 ]; then
              COVERAGE=$(echo "scale=2; $HITS * 100 / $LINES" | bc)
              echo "## Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  #=============================================================================
  # Job 3: Build Verification (Android Debug)
  #=============================================================================
  build-check:
    name: Build Check (Android)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint
    # Run in parallel with tests for faster feedback

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Android debug APK
        id: build
        run: |
          echo "## Build Verification" >> $GITHUB_STEP_SUMMARY
          START_TIME=$(date +%s)

          # Build debug APK (no signing required)
          if flutter build apk --debug --no-tree-shake-icons 2>&1 | tee build.log; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))

            # Get APK size
            APK_PATH="build/app/outputs/flutter-apk/app-debug.apk"
            if [ -f "$APK_PATH" ]; then
              APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
              echo "Android debug build successful." >> $GITHUB_STEP_SUMMARY
              echo "- APK Size: $APK_SIZE" >> $GITHUB_STEP_SUMMARY
              echo "- Build Time: ${DURATION}s" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "::error::Android build failed. See build log for details."
            echo "Android build failed - see workflow log." >> $GITHUB_STEP_SUMMARY
            tail -50 build.log >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Check for build warnings
        run: |
          if grep -i "warning" build.log | grep -v "deprecated" | head -20 > warnings.txt; then
            if [ -s warnings.txt ]; then
              echo "### Build Warnings" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat warnings.txt >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  #=============================================================================
  # PR Status Summary
  #=============================================================================
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [lint, test, build-check]
    if: always()

    steps:
      - name: Generate PR summary
        run: |
          echo "# Mobile PR Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Lint status
          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "- Lint & Format: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Lint & Format: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Test status
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "- Unit Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Unit Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Build status
          if [ "${{ needs.build-check.result }}" == "success" ]; then
            echo "- Build Check: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Build Check: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.build-check.result }}" == "success" ]; then
            echo "## Ready to Merge" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Issues Found - Please Fix Before Merging" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for failures
        if: needs.lint.result != 'success' || needs.test.result != 'success' || needs.build-check.result != 'success'
        run: |
          echo "::error::One or more checks failed. Please fix the issues before merging."
          exit 1
